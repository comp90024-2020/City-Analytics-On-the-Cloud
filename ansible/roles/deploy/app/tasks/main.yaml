---
- name: Upload compose file
  become: yes
  template:
    src: docker-compose.yaml.j2
    dest: '{{ repository.dest }}/app/docker-compose.yaml'
    owner: '{{ ansible_user }}'
    group: '{{ ansible_user }}'

# Use docker-compose to up -d app
- name: Setup app
  docker_compose:
    project_src: '{{ repository.dest }}/app'
    build: yes
    state: present
    remove_orphans: yes
    recreate: smart
  register: setup_app
  until: setup_app is not failed
  retries: 5
